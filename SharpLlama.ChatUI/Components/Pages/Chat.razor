@page "/"
@inject ChatService Chats
@inject ChatState State
@rendermode InteractiveServer
@* PSEUDOCODE PLAN
- Goal: Fix handler that doesn't fire when button is clicked.
- Issues observed:
  - `textarea` is self-closed; HTML non-void element must have explicit closing tag in Razor/Blazor. This can break event handling.
  - Form relies on `@onsubmit`; switching to explicit button `@onclick` avoids submit-related issues and is more reliable.
  - Ensure non-submit buttons have `type="button"` so they don't trigger form submit.
  - Optionally force re-render after config apply for immediate status update.

- Changes:
  1) Replace self-closing `<textarea />` with `<textarea></textarea>` while keeping `@bind`.
  2) Remove `@onsubmit` from `<form>` and wire `Send` to `@onclick="OnSend"` with `type="button"`.
  3) Add `type="button"` to `Apply` and `Warmup` buttons to prevent unintended form submits.
  4) Optionally call `StateHasChanged()` after applying config (not strictly necessary, but safe).
*@>

<h1>SharpLlama Chat</h1>

<div class="config">
    <label>API Base URL:
        <input @bind="_baseUrl" placeholder="https://localhost:7055" />
    </label>
    <label>API Key:
        <input @bind="_apiKey" />
    </label>
    <button type="button" @onclick="ApplyConfig">Apply</button>
    <button type="button" @onclick="Warmup" disabled="@_warming">Warmup</button>
    @if(_warmupOk is true) { <span class="ok">Warmup OK</span> }
    @if(_warmupOk is false){ <span class="err">Warmup failed</span> }
</div>

<div class="chat-window">
    @foreach (var m in State.Messages)
    {
        <div class="msg @(m.Role)">
            <b>@m.Role:</b>
            <span>@m.Content</span>
        </div>
    }
</div>

<form>
    <textarea @bind="_prompt" rows="3" placeholder="Type your prompt..."></textarea>
    <div>
        <button type="button" disabled="@_sending" @onclick="OnSend">Send</button>
        <button type="button" @onclick="Clear">Clear</button>
    </div>
</form>

@if(!string.IsNullOrWhiteSpace(_status))
{
    <p class="status">@_status</p>
}

@code {
    private string _baseUrl = "https://localhost:7055";
    private string? _apiKey;
    private string _prompt = "";
    private bool _sending;
    private bool _warming;
    private bool? _warmupOk;
    private string? _status;

    private void ApplyConfig()
    {
        Chats.Configure(_baseUrl, _apiKey);
        _status = "Configuration applied.";
        StateHasChanged();
    }

    private async Task Warmup()
    {
        try
        {
            _warming = true;
            _warmupOk = await Chats.WarmupAsync();
        }
        catch
        {
            _warmupOk = false;
        }
        finally
        {
            _warming = false;
        }
    }

    private async Task OnSend()
    {
        if (string.IsNullOrWhiteSpace(_prompt)) return;
        _sending = true;
        var toSend = _prompt;
        _prompt = "";
        try
        {
            await Chats.SendAsync(toSend);
        }
        catch (Exception ex)
        {
            State.Add("assistant", $"[Client Error] {ex.Message}");
        }
        finally
        {
            _sending = false;
            StateHasChanged();
        }
    }

    private void Clear()
    {
        State.Clear();
        _status = "Cleared.";
    }
}